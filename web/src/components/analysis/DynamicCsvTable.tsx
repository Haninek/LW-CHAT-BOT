import React, { useMemo, useState } from 'react'
type Row = Record<string,string>
export default function DynamicCsvTable({rowsRaw}:{rowsRaw:Row[]}){const[Q,setQ]=useState('');const[open,setOpen]=useState<number|null>(null);if(!rowsRaw?.length)return null;const headers=Object.keys(rowsRaw[0]);const rows=useMemo(()=>Q?rowsRaw.filter(r=>Object.values(r).some(v=>String(v).toLowerCase().includes(Q.toLowerCase()))):rowsRaw,[rowsRaw,Q]);const usd=(n:number)=>new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n);const fmt=(k:string,v:string)=>{if(v==null||v==='')return'—';const n=Number(String(v).replace(/[$,]/g,''));if(Number.isFinite(n)){if(/total|balance|deposit|withdraw|amount|min|max|revenue|expense|debt|cash|payback|advance|daily/i.test(k))return n<0?<span className="text-red-600">({usd(Math.abs(n))})</span>:usd(n);if(/count|days|nsf/i.test(k))return n.toLocaleString()}return v};return(<div className="bg-white rounded-2xl p-4 shadow-sm border"><div className="flex items-center justify-between mb-3"><h3 className="text-lg font-semibold">All Monthly Fields</h3><input value={Q} onChange={e=>setQ(e.target.value)} placeholder="Search rows…" className="border rounded px-3 py-1.5 text-sm"/></div><div className="overflow-x-auto"><table className="min-w-full text-sm"><thead className="bg-slate-50 text-slate-600"><tr className="[&>th]:px-3 [&>th]:py-2"><th className="w-10"></th>{headers.map(h=><th key={h}>{h}</th>)}</tr></thead><tbody className="divide-y divide-slate-100">{rows.map((r,i)=>(<React.Fragment key={i}><tr className="[&>td]:px-3 [&>td]:py-2 hover:bg-slate-50"><td><button onClick={()=>setOpen(open===i?null:i)} className="text-slate-500">{open===i?'−':'+'}</button></td>{headers.map(h=><td key={h} title={String(r[h]??'')} className="whitespace-nowrap max-w-[260px] truncate">{fmt(h,String(r[h]??''))}</td>)}</tr>{open===i&&(<tr><td colSpan={1+headers.length} className="bg-slate-50"><div className="grid md:grid-cols-2 lg:grid-cols-3 gap-3 p-3">{headers.map(h=>(<div key={h} className="text-xs"><div className="text-slate-500">{h}</div><div className="font-medium break-all">{String(r[h]??'')}</div></div>))}</div></td></tr>)}</React.Fragment>))}</tbody></table></div></div>)}
